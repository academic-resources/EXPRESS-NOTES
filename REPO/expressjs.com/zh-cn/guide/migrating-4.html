<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn" xml:lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>迁移到 Express 4</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">迁移到 Express 4</h1>
    </header>
    <h1 id="迁移到-express-4">迁移到 Express 4</h1>
    <h2 id="overview">概述</h2>
    <p>
      Express 4 对 Express 3 进行了重大更改，这意味着，如果您在现有 Express 3
      应用程序的依赖项中更新了 Express 版本，那么该应用程序将无法工作。
    </p>
    <p>本文讲述：</p>
    <ul class="doclist">
      <li>
        <a href="#changes">Express 4 中的更改。</a>
      </li>
      <li>
        将 Express 3 应用程序迁移到 Express 4 的<a href="#example-migration"
          >示例</a
        >。
      </li>
      <li>
        <a href="#app-gen">升级到 Express 4 应用程序生成器。</a>
      </li>
    </ul>
    <h2 id="changes">Express 4 中的更改</h2>
    <p>Express 4 中进行了若干重大更改：</p>
    <ul class="doclist">
      <li>
        <a href="#core-changes">对 Express 核心和中间件系统进行了更改。</a
        >移除了 Connect 依赖项和内置的中间件，所以您必须自己添加中间件。
      </li>
      <li>
        <a href="#routing">对路由系统进行了更改。</a>
      </li>
      <li>
        <a href="#other-changes">其他各种更改。</a>
      </li>
    </ul>
    <p>另请参阅：</p>
    <ul>
      <li>
        <a href="https://github.com/expressjs/express/wiki/New-features-in-4.x"
          >New features in 4.x</a
        >。
      </li>
      <li>
        <a
          href="https://github.com/expressjs/express/wiki/Migrating-from-3.x-to-4.x"
          >Migrating from 3.x to 4.x</a
        >。
      </li>
    </ul>
    <h3 id="core-changes">对 Express 核心和中间件系统的更改。</h3>
    <p>
      Express 4 不再依赖于 Connect，从其核心移除了所有内置的中间件（除了
      <code>express.static</code> 函数）。这意味着 Express
      现在是独立的路由和中间件 Web 框架，Express
      的版本控制和发行不受中间件更新的影响。
    </p>
    <p>
      由于没有内置中间件，因此您必须显式添加所需的所有中间件才能运行应用程序。只需执行以下步骤：
    </p>
    <ol type="1">
      <li>安装模块：<code>npm install --save &lt;module-name&gt;</code></li>
      <li>在应用程序中需要此模块：<code>require('module-name')</code></li>
      <li>根据文档使用模块：<code>app.use( ... )</code></li>
    </ol>
    <p>下表列出了 Express 3 中间件及其在 Express 4 中的对应组件。</p>
    <table class="doctable" border="1">
      <tr>
        <th>Express 3</th>
        <th>Express 4</th>
      </tr>
      <tr>
        <td>
          <code>express.bodyParser</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/body-parser">body-parser</a> +
          <a href="https://github.com/expressjs/multer">multer</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.compress</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/compression">compression</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.cookieSession</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/cookie-session"
            >cookie-session</a
          >
        </td>
      </tr>
      <tr>
        <td>
          <code>express.cookieParser</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/cookie-parser">cookie-parser</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.logger</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/morgan">morgan</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.session</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/session">express-session</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.favicon</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/serve-favicon">serve-favicon</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.responseTime</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/response-time">response-time</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.errorHandler</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/errorhandler">errorhandler</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.methodOverride</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/method-override"
            >method-override</a
          >
        </td>
      </tr>
      <tr>
        <td>
          <code>express.timeout</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/timeout">connect-timeout</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.vhost</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/vhost">vhost</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.csrf</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/csurf">csurf</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.directory</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/serve-index">serve-index</a>
        </td>
      </tr>
      <tr>
        <td>
          <code>express.static</code>
        </td>
        <td>
          <a href="https://github.com/expressjs/serve-static">serve-static</a>
        </td>
      </tr>
    </table>
    <p>
      可参考 Express 4 中间件的<a
        href="https://github.com/senchalabs/connect#middleware"
        >完整列表</a
      >。
    </p>
    <p>
      在大多数情况下，可以将旧的 V3 中间件替换为 Express 4
      的对应组件。有关详细信息，请参阅 GitHub 中的模块文档。
    </p>
    <h4 id="app-use"><code>app.use</code> 可以使用参数</h4>
    <p>
      在 V4
      中，您可以使用变量参数来定义装入中间件函数的路径，然后从路由处理程序读取参数的值。
      例如：
    </p>
    <pre>
<code class="language-javascript" translate="no">
app.use('/book/:id', function(req, res, next) {
  console.log('ID:', req.params.id);
  next();
});
</code>
</pre>
    <h3 id="routing">路由系统</h3>
    <p>
      应用程序现在隐式装入路由中间件，所以您不再需要担心其他中间件相对于<code>路由</code>中间件的装入顺序。
    </p>
    <p>
      定义路由的方式并未改变，但是路由系统新增了两个功能，用于帮助组织路由：
    </p>
    <p>
      {: .doclist } * 一个新方法
      <code>app.route()</code>，用于为路由路径创建可链接的路由处理程序。 *
      一个新类 <code>express.Router</code>，用于创建可安装的模块化路由处理程序。
    </p>
    <h4 id="app-route"><code>app.route()</code> 方法</h4>
    <p>
      新的
      <code>app.route()</code>
      方法使您可以为路由路径创建可链接的路由处理程序。创建模块化路由很有帮助，因为在单一位置指定路径，所以可以减少冗余和输入错误。有关路由的更多信息，请参阅
      <a href="/%7B%7B%20page.lang%20%7D%7D/4x/api.html#router"
        ><code>Router()</code> 文档</a
      >。
    </p>
    <p>
      以下是使用 <code>app.route()</code> 函数定义的链式路由处理程序的示例。
    </p>
    <pre>
<code class="language-javascript" translate="no">
app.route('/book')
  .get(function(req, res) {
    res.send('Get a random book');
  })
  .post(function(req, res) {
    res.send('Add a book');
  })
  .put(function(req, res) {
    res.send('Update the book');
  });
</code>
</pre>
    <h4 id="express-router"><code>express.Router</code> 类</h4>
    <p>
      有助于组织路由的另一个功能是新类
      <code>express.Router</code>，可用于创建可安装的模块化路由处理程序。<code
        >Router</code
      >
      实例是完整的中间件和路由系统；因此，常常将其称为“微型应用程序”。
    </p>
    <p>
      以下示例将路由器创建为模块，在其中装入中间件，定义一些路由，然后安装在主应用程序的路径中。
    </p>
    <p>
      例如，在应用程序目录中创建名为
      <code>birds.js</code> 的路由器文件，其中包含以下内容：
    </p>
    <pre>
<code class="language-javascript" translate="no">
var express = require('express');
var router = express.Router();

// middleware specific to this router
router.use(function timeLog(req, res, next) {
  console.log('Time: ', Date.now());
  next();
});
// define the home page route
router.get('/', function(req, res) {
  res.send('Birds home page');
});
// define the about route
router.get('/about', function(req, res) {
  res.send('About birds');
});

module.exports = router;
</code>
</pre>
    <p>接着，在应用程序中装入路由器模块：</p>
    <pre>
<code class="language-javascript" translate="no">
var birds = require('./birds');
...
app.use('/birds', birds);
</code>
</pre>
    <p>
      此应用程序现在可处理针对 <code>/birds</code> 和
      <code>/birds/about</code> 路径的请求，调用特定于此路由的
      <code>timeLog</code> 中间件。
    </p>
    <h3 id="other-changes">其他更改</h3>
    <p>下表列出 Express 4 中虽小但重要的其他更改：</p>
    <table class="doctable" border="1">
      <tr>
        <th>对象</th>
        <th>描述</th>
      </tr>
      <tr>
        <td>Node.js</td>
        <td>
          Express 4 需要 Node.js 0.10.x 或更高版本，已取消对 Node.js 0.8.x
          的支持。
        </td>
      </tr>
      <tr>
        <td>
          <code>http.createServer()</code>
        </td>
        <td>
          不再需要 <code>http</code> 模块，除非您要直接使用它
          (socket.io/SPDY/HTTPS)。可以使用
          <code>app.listen()</code> 函数来启动此应用程序。
        </td>
      </tr>
      <tr>
        <td>
          <code>app.configure()</code>
        </td>
        <td>
          已移除 <code>app.configure()</code> 函数。使用
          <code>process.env.NODE_ENV</code> 或
          <code>app.get('env')</code> 功能来检测环境并相应配置该应用程序。
        </td>
      </tr>
      <tr>
        <td>
          <code>json spaces</code>
        </td>
        <td>
          在 Express 4 中，缺省情况下，已禁用
          <code>json spaces</code> 应用程序属性。
        </td>
      </tr>
      <tr>
        <td>
          <code>req.accepted()</code>
        </td>
        <td>
          使用
          <code>req.accepts()</code>、<code>req.acceptsEncodings()</code>、<code
            >req.acceptsCharsets()</code
          >
          和 <code>req.acceptsLanguages()</code>。
        </td>
      </tr>
      <tr>
        <td>
          <code>res.location()</code>
        </td>
        <td>不再解析相对 URL。</td>
      </tr>
      <tr>
        <td>
          <code>req.params</code>
        </td>
        <td>原来是数组；现在是对象。</td>
      </tr>
      <tr>
        <td>
          <code>res.locals</code>
        </td>
        <td>原来是函数；现在是对象。</td>
      </tr>
      <tr>
        <td>
          <code>res.headerSent</code>
        </td>
        <td>更改为 <code>res.headersSent</code>。</td>
      </tr>
      <tr>
        <td>
          <code>app.route</code>
        </td>
        <td>现在可作为 <code>app.mountpath</code> 使用。</td>
      </tr>
      <tr>
        <td>
          <code>res.on('header')</code>
        </td>
        <td>已移除。</td>
      </tr>
      <tr>
        <td>
          <code>res.charset</code>
        </td>
        <td>已移除。</td>
      </tr>
      <tr>
        <td>
          <code>res.setHeader('Set-Cookie', val)</code>
        </td>
        <td>
          功能现在已限制为设置基本 cookie 值。将
          <code>res.cookie()</code> 用于增添的功能。
        </td>
      </tr>
    </table>
    <h2 id="example-migration">应用程序迁移示例</h2>
    <p>
      以下是将 Express 3 应用程序迁移到 Express 4 的示例。 涉及的文件包括
      <code>app.js</code> 和 <code>package.json</code>。
    </p>
    <h3 id>V3 应用程序</h3>
    <h4 id>
      <code>app.js</code>
    </h4>
    <p>考虑具有以下 <code>app.js</code> 文件的 Express V3 应用程序：</p>
    <pre>
<code class="language-javascript" translate="no">
var express = require('express');
var routes = require('./routes');
var user = require('./routes/user');
var http = require('http');
var path = require('path');

var app = express();

// all environments
app.set('port', process.env.PORT || 3000);
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'pug');
app.use(express.favicon());
app.use(express.logger('dev'));
app.use(express.methodOverride());
app.use(express.session({ secret: 'your secret here' }));
app.use(express.bodyParser());
app.use(app.router);
app.use(express.static(path.join(__dirname, 'public')));

// development only
if ('development' == app.get('env')) {
  app.use(express.errorHandler());
}

app.get('/', routes.index);
app.get('/users', user.list);

http.createServer(app).listen(app.get('port'), function(){
  console.log('Express server listening on port ' + app.get('port'));
});
</code>
</pre>
    <h4 id>
      <code>package.json</code>
    </h4>
    <p>随附的 V3 <code>package.json</code> 文件可能具有类似于以下的内容：</p>
    <pre>
<code class="language-javascript" translate="no">
{
  "name": "application-name",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "express": "3.12.0",
    "pug": "*"
  }
}
</code>
</pre>
    <h3 id>进程</h3>
    <p>
      使用以下命令安装 Express 4 应用程序的必需中间件并将 Express 和 Pug
      分别更新到其最新版本，从而开始迁移过程：
    </p>
    <pre>
<code class="language-sh" translate="no">
$ npm install serve-favicon morgan method-override express-session body-parser multer errorhandler express@latest pug@latest --save
</code>
</pre>
    <p>对 <code>app.js</code> 进行以下更改：</p>
    <ol type="1">
      <li>
        <p>
          Express 内置中间件函数
          <code>express.favicon</code
          >、<code>express.logger</code>、<code>express.methodOverride</code>、<code>express.session</code>、<code
            >express.bodyParser</code
          >
          和 <code>express.errorHandler</code> 不再可用于
          <code>express</code>
          对象。您必须手动安装其替代项，然后在应用程序中装入。
        </p>
      </li>
      <li>
        <p>
          不再需要装入 <code>app.router</code> 函数。它不是有效的 Express 4
          应用程序对象，所以移除了 <code>app.use(app.router);</code> 代码。
        </p>
      </li>
      <li>
        <p>
          确保以正确顺序装入中间件函数 - 在装入应用程序路由之后装入
          <code>errorHandler</code>。
        </p>
      </li>
    </ol>
    <h3 id>V4 应用程序</h3>
    <h4 id>
      <code>package.json</code>
    </h4>
    <p>
      运行以上 <code>npm</code> 命令会更新 <code>package.json</code>，如下所示：
    </p>
    <pre>
<code class="language-javascript" translate="no">
{
  "name": "application-name",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "body-parser": "^1.5.2",
    "errorhandler": "^1.1.1",
    "express": "^4.8.0",
    "express-session": "^1.7.2",
    "pug": "^2.0.0-beta6",
    "method-override": "^2.1.2",
    "morgan": "^1.2.2",
    "multer": "^0.1.3",
    "serve-favicon": "^2.0.1"
  }
}
</code>
</pre>
    <h4 id>
      <code>app.js</code>
    </h4>
    <p>
      随后，移除无效代码，装入所需中间件，并根据需要进行其他更改。<code
        >app.js</code
      >
      文件如下：
    </p>
    <pre>
<code class="language-javascript" translate="no">
var http = require('http');
var express = require('express');
var routes = require('./routes');
var user = require('./routes/user');
var path = require('path');

var favicon = require('serve-favicon');
var logger = require('morgan');
var methodOverride = require('method-override');
var session = require('express-session');
var bodyParser = require('body-parser');
var multer = require('multer');
var errorHandler = require('errorhandler');

var app = express();

// all environments
app.set('port', process.env.PORT || 3000);
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'pug');
app.use(favicon(__dirname + '/public/favicon.ico'));
app.use(logger('dev'));
app.use(methodOverride());
app.use(session({ resave: true,
                  saveUninitialized: true,
                  secret: 'uwotm8' }));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(multer());
app.use(express.static(path.join(__dirname, 'public')));

app.get('/', routes.index);
app.get('/users', user.list);

// error handling middleware should be loaded after the loading the routes
if ('development' == app.get('env')) {
  app.use(errorHandler());
}

var server = http.createServer(app);
server.listen(app.get('port'), function(){
  console.log('Express server listening on port ' + app.get('port'));
});
</code>
</pre>
    <div class="doc-box doc-info" data-markdown="1">
      除非您需要直接使用 <code>http</code> 模块
      (socket.io/SPDY/HTTPS)，否则不需要将其装入，可按以下方式启动此应用程序：
      <pre>
<code class="language-js" translate="no">app.listen(app.get('port'), function(){
  console.log('Express server listening on port ' + app.get('port'));
});</code>
</pre>
    </div>
    <h3 id>运行应用程序</h3>
    <p>
      迁移过程完成，此应用程序现在是 Express 4
      版本。要进行确认，可使用以下命令启动此应用程序：
    </p>
    <pre>
<code class="language-sh" translate="no">
$ node .
</code>
</pre>
    <p>
      装入 <a href="http://localhost:3000">http://localhost:3000</a>，然后查看
      Express 4 呈现的主页。
    </p>
    <h2 id="app-gen">升级到 Express 4 应用程序生成器</h2>
    <p>
      用于生成 Express 应用程序的命令行工具仍然是
      <code>express</code>，但是要升级到新版本，您必须卸载 Express 3
      应用程序生成器，然后安装新的 <code>express-generator</code>。
    </p>
    <h3 id>安装</h3>
    <p>如果您已经在系统上安装了 Express 3 应用程序生成器，必须将其卸载：</p>
    <pre>
<code class="language-sh" translate="no">
$ npm uninstall -g express
</code>
</pre>
    <p>
      根据您的文件和目录特权的配置方式，可能需要使用
      <code>sudo</code> 来运行此命令。 立即安装新的生成器：
    </p>
    <pre>
<code class="language-sh" translate="no">
$ npm install -g express-generator
</code>
</pre>
    <p>
      根据您的文件和目录特权的配置方式，可能需要使用
      <code>sudo</code> 来运行此命令。
    </p>
    <p>现在，系统上的 <code>express</code> 命令已更新到 Express 4 生成器。</p>
    <h3 id>对应用程序生成器的更改</h3>
    <p>命令选项和用法大体保持相同，但也存在以下例外：</p>
    <p>
      {: .doclist } * 已移除 <code>--sessions</code> 选项。 * 已移除
      <code>--jshtml</code> 选项。 * 已添加 <code>--hogan</code> 选项来支持
      <a href="http://twitter.github.io/hogan.js/">Hogan.js</a>。
    </p>
    <h3 id>示例</h3>
    <p>执行以下命令来创建 Express 4 应用程序：</p>
    <pre>
<code class="language-sh" translate="no">
$ express app4
</code>
</pre>
    <p>
      如果查看
      <code>app4/app.js</code>
      文件的内容，那么会注意到应用程序所需的所有中间件函数（除了
      <code>express.static</code
      >）都作为独立模块装入，而在应用程序中不再显式装入
      <code>router</code> 中间件。
    </p>
    <p>
      还可以注意到，与旧生成器生成的独立应用程序相反，<code>app.js</code>
      文件现在是 Node.js 模块。
    </p>
    <p>在安装依赖项之后，可使用以下命令来启动此应用程序：</p>
    <pre>
<code class="language-sh" translate="no">
$ npm start
</code>
</pre>
    <p>
      如果查看 <code>package.json</code> 文件中的 npm
      启动脚本，可以注意到启动应用程序的实际命令是
      <code>node ./bin/www</code>，而过去在 Express 3 中，该命令是
      <code>node app.js</code>。
    </p>
    <p>
      因为 Express 4 生成器生成的 <code>app.js</code> 文件现在是 Node.js
      模块，所以不再能够将其作为应用程序独立启动（除非修改代码）。必须在 Node.js
      文件中加载此模块，并通过 Node.js 文件启动。在此情况下，Node.js 文件是
      <code>./bin/www</code>。
    </p>
    <p>
      对于创建 Express 应用程序或启动此应用程序，<code>bin</code>
      目录或无扩展名的
      <code>www</code>
      文件都不是必需的。它们只是生成器提出的建议，可随意根据自己的需求进行修改。
    </p>
    <p>
      如果不想使用 <code>www</code> 目录，而是保持“Express 3 风格”，请删除
      <code>app.js</code> 文件末尾的
      <code>module.exports = app;</code> 行，然后将以下代码粘贴在到该位置：
    </p>
    <pre>
<code class="language-javascript" translate="no">
app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});
</code>
</pre>
    <p>
      确保使用以下代码在 <code>app.js</code> 文件之上装入
      <code>debug</code> 模块：
    </p>
    <pre>
<code class="language-javascript" translate="no">
var debug = require('debug')('app4');
</code>
</pre>
    <p>
      下一步，将 <code>package.json</code> 文件中的
      <code>"start": "node ./bin/www"</code> 更改为
      <code>"start": "node app.js"</code>。
    </p>
    <p>
      现在，您已将 <code>./bin/www</code> 的功能恢复为
      <code>app.js</code>。不建议进行此更改，但是此练习可以帮助您理解
      <code>./bin/www</code> 文件的工作方式，以及为何
      <code>app.js</code> 文件不再自行启动。
    </p>
  </body>
</html>
